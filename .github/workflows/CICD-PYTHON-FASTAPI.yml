# ===================================================================
# ë²”ìš© Python FastAPI CI/CD ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ===================================================================

name: CICD-PYTHON-FASTAPI

# ===================================================================
# íŠ¸ë¦¬ê±° ì„¤ì •
# ===================================================================
on:
  push:
    branches:
      # NOTE: ì‚¬ìš© í•  ë¸Œëžœì¹˜ë§Œ ë¹¼ê³  ì£¼ì„ì²˜ë¦¬
      # - main      # í”„ë¡œë•ì…˜ ë°°í¬
      # - release   # í”„ë¡œë•ì…˜ ë°°í¬
      # - develop   # ê°œë°œ í™˜ê²½ ë°°í¬
      - test      # í…ŒìŠ¤íŠ¸ í™˜ê²½ ë°°í¬
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  # ===================================================================
  # ë¹Œë“œ ìž‘ì—…
  # ===================================================================
  build:
    name: Python FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. ë¹Œë“œ ì„¤ì • ë¡œë“œ
      - name: ë¹Œë“œ ì„¤ì • ë¡œë“œ
        id: config
        run: |
          echo "âš™ï¸ deploy.env íŒŒì¼ì—ì„œ ë¹Œë“œ ì„¤ì •ì„ ë¡œë“œí•©ë‹ˆë‹¤..."
          
          # deploy.env íŒŒì¼ ì½ê¸°
          while IFS='=' read -r key value; do
            # ì£¼ì„ê³¼ ë¹ˆ ì¤„ ë¬´ì‹œ
            if [[ ! $key =~ ^#.*$ ]] && [[ -n $key ]] && [[ ! $key =~ ^[[:space:]]*$ ]]; then
              # ì•žë’¤ ê³µë°± ì œê±°
              key=$(echo "$key" | xargs)
              value=$(echo "$value" | xargs)
              
              # í™˜ê²½ë³€ìˆ˜ í˜•íƒœë¡œ ë³€í™˜í•˜ì—¬ GitHub Actions ì¶œë ¥ì— ì„¤ì •
              echo "${key}=${value}" >> $GITHUB_OUTPUT
              echo "âœ… ì„¤ì • ë¡œë“œ: ${key}=${value}"
            fi
          done < .github/config/deploy.env

      # 3. .env íŒŒì¼ ìƒì„±
      - name: .env íŒŒì¼ ìƒì„±
        run: |
          cat > .env << 'EOF'
          ${{ secrets.ENV }}
          EOF
          echo "âœ… .env íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"

      # 4. Docker ë¹Œë“œ í™˜ê²½ ì„¤ì •
      - name: Docker ë¹Œë“œí™˜ê²½ ì„¤ì •
        uses: docker/setup-buildx-action@v3

      # 5. DockerHub ë¡œê·¸ì¸
      - name: DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 6. Docker ë ˆì´ì–´ ìºì‹± ì„¤ì •
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # 7. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ steps.config.outputs.PROJECT_NAME }}:${{ github.ref_name }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      # 8. Docker ìºì‹œ ì •ë¦¬
      - name: Move Docker cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  # ===================================================================
  # ë°°í¬ ìž‘ì—…
  # ===================================================================
  deploy:
    name: ì›ê²© ì„œë²„ ë°°í¬
    needs: build
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì„¤ì • íŒŒì¼ ì½ê¸°ìš©)
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. ë°°í¬ ì„¤ì • ë¡œë“œ
      - name: ë°°í¬ ì„¤ì • ë¡œë“œ
        id: config
        run: |
          echo "ðŸ“„ deploy.env íŒŒì¼ì—ì„œ ì„¤ì •ì„ ë¡œë“œí•©ë‹ˆë‹¤..."
          
          # deploy.env íŒŒì¼ ì½ê¸°
          while IFS='=' read -r key value; do
            # ì£¼ì„ê³¼ ë¹ˆ ì¤„ ë¬´ì‹œ
            if [[ ! $key =~ ^#.*$ ]] && [[ -n $key ]] && [[ ! $key =~ ^[[:space:]]*$ ]]; then
              # ì•žë’¤ ê³µë°± ì œê±°
              key=$(echo "$key" | xargs)
              value=$(echo "$value" | xargs)
              
              # í™˜ê²½ë³€ìˆ˜ í˜•íƒœë¡œ ë³€í™˜í•˜ì—¬ GitHub Actions ì¶œë ¥ì— ì„¤ì •
              echo "${key}=${value}" >> $GITHUB_OUTPUT
              echo "âœ… ì„¤ì • ë¡œë“œ: ${key}=${value}"
            fi
          done < .github/config/deploy.env

      # 3. SSHë¥¼ í†µí•œ ì›ê²© ì„œë²„ ë°°í¬ ì‹¤í–‰
      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            set -e

            # ============================================================
            # ì„¤ì •ê°’ ë¡œë“œ
            # ============================================================
            echo "ðŸ”§ ë°°í¬ ì„¤ì • ë¡œë“œ ì¤‘..."
            
            # GitHubì—ì„œ ì „ë‹¬ë°›ì€ ë¸Œëžœì¹˜ëª…
            BRANCH="${{ github.ref_name }}"
            
            # í”„ë¡œì íŠ¸ ì„¤ì • (config íŒŒì¼ì—ì„œ ë¡œë“œëœ ê°’ë“¤)
            PROJECT_NAME="${{ steps.config.outputs.PROJECT_NAME }}"
            PROJECT_BASE_PATH="${{ steps.config.outputs.PROJECT_BASE_PATH }}"
            PROJECT_FOLDER_NAME="${{ steps.config.outputs.PROJECT_FOLDER_NAME }}"
            PROJECT_SUB_PATH="${{ steps.config.outputs.PROJECT_SUB_PATH }}"
            
            # í¬íŠ¸ ì„¤ì •
            PRODUCTION_PORT="${{ steps.config.outputs.PRODUCTION_PORT }}"
            DEVELOPMENT_PORT="${{ steps.config.outputs.DEVELOPMENT_PORT }}"
            TEST_PORT="${{ steps.config.outputs.TEST_PORT }}"
            
            # ê²½ë¡œ ì„¤ì • (PROJECT_NAME ê¸°ë°˜ìœ¼ë¡œ í†µí•©)
            HOST_MOUNT_PATH="${PROJECT_BASE_PATH}/${PROJECT_FOLDER_NAME}/${PROJECT_SUB_PATH}"
            CONTAINER_MOUNT_PATH="/mnt/${PROJECT_FOLDER_NAME}"

            # ============================================================
            # ë¸Œëžœì¹˜ë³„ í¬íŠ¸ ë° ì»¨í…Œì´ë„ˆëª… ì„¤ì •
            # ============================================================
            if [ "$BRANCH" == "main" ] || [ "$BRANCH" == "release" ]; then
              # ðŸ­ í”„ë¡œë•ì…˜ í™˜ê²½
              PORT="$PRODUCTION_PORT"
              CONTAINER_NAME="${PROJECT_NAME}"
              echo "ðŸ­ í”„ë¡œë•ì…˜ í™˜ê²½ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤"

            elif [ "$BRANCH" == "develop" ]; then
              # ðŸ–¥ï¸ ê°œë°œ í™˜ê²½
              PORT="$DEVELOPMENT_PORT"
              CONTAINER_NAME="${PROJECT_NAME}-dev"
              echo "ðŸ–¥ï¸ ê°œë°œ í™˜ê²½ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤"

            elif [ "$BRANCH" == "test" ]; then
              # ðŸ§ª í…ŒìŠ¤íŠ¸ í™˜ê²½
              PORT="$TEST_PORT"
              CONTAINER_NAME="${PROJECT_NAME}-test"
              echo "ðŸ§ª í…ŒìŠ¤íŠ¸ í™˜ê²½ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤"

            else
              # âš ï¸ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œëžœì¹˜
              echo "âš ï¸ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œëžœì¹˜ìž…ë‹ˆë‹¤: $BRANCH"
              exit 1
            fi

            # ì„¤ì • ì •ë³´ ì¶œë ¥
            echo "ðŸ“‹ ë°°í¬ ì„¤ì • ì •ë³´:"
            echo "  - í”„ë¡œì íŠ¸: $PROJECT_NAME"
            echo "  - ë¸Œëžœì¹˜: $BRANCH"
            echo "  - Docker ì´ë¯¸ì§€: ${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:${BRANCH}"
            echo "  - ì»¨í…Œì´ë„ˆ ì´ë¦„: $CONTAINER_NAME"
            echo "  - í¬íŠ¸: $PORT"
            echo "  - í˜¸ìŠ¤íŠ¸ ë§ˆìš´íŠ¸ ê²½ë¡œ: $HOST_MOUNT_PATH"
            echo "  - ì»¨í…Œì´ë„ˆ ë§ˆìš´íŠ¸ ê²½ë¡œ: $CONTAINER_MOUNT_PATH"

            # ============================================================
            # Docker ì´ë¯¸ì§€ í’€ (Pull)
            # ============================================================
            echo "â¬‡ï¸ Docker ì´ë¯¸ì§€ í’€: ${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:${BRANCH}"
            docker pull "${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:${BRANCH}"

            # ============================================================
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            # ============================================================
            echo "ðŸ§¹ ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì¡´ìž¬ ì—¬ë¶€ í™•ì¸ ì¤‘..."

            if docker ps -a --format '{{.Names}}' | grep -Eq "^${CONTAINER_NAME}\$"; then
              echo "âš ï¸ ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì´(ê°€) ì¡´ìž¬í•©ë‹ˆë‹¤. ì¤‘ì§€ ë° ì‚­ì œ ì¤‘..."
              docker rm -f "$CONTAINER_NAME"
              echo "âœ… ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "â„¹ï¸ ì¡´ìž¬í•˜ëŠ” ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì´(ê°€) ì—†ìŠµë‹ˆë‹¤."
            fi

            # ============================================================
            # í˜¸ìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ ì¤€ë¹„
            # ============================================================
            echo "ðŸ“‚ í˜¸ìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ ì¤€ë¹„: $HOST_MOUNT_PATH"
            mkdir -p "$HOST_MOUNT_PATH"

            # ============================================================
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            # ============================================================
            echo "ðŸš€ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì‹¤í–‰ ì¤‘..."

            # Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker run -d \
              -p "${PORT}:8000" \
              --name "$CONTAINER_NAME" \
              --env-file .env \
              -e TZ=Asia/Seoul \
              -v /etc/localtime:/etc/localtime:ro \
              -v "${HOST_MOUNT_PATH}:${CONTAINER_MOUNT_PATH}" \
              "${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:${BRANCH}"

            # ============================================================
            # ë°°í¬ ì™„ë£Œ í™•ì¸
            # ============================================================
            echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo ""
            echo "ðŸ“‹ ë°°í¬ ê²°ê³¼ ìš”ì•½:"
            echo "  ðŸŽ¯ í”„ë¡œì íŠ¸: $PROJECT_NAME"
            echo "  ðŸŒ¿ ë¸Œëžœì¹˜: $BRANCH"
            echo "  ðŸ³ ì»¨í…Œì´ë„ˆ: $CONTAINER_NAME"
            echo "  ðŸŒ í¬íŠ¸: $PORT"
            echo "  ðŸ“‚ í˜¸ìŠ¤íŠ¸ ê²½ë¡œ: $HOST_MOUNT_PATH"
            echo "  ðŸ“ ì»¨í…Œì´ë„ˆ ê²½ë¡œ: $CONTAINER_MOUNT_PATH"
            echo "  â° ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
            echo ""
            echo "ðŸ”— ì ‘ì† URL: http://${{ secrets.SERVER_HOST }}:${PORT}/docs"
